---
- name: Get current status of container
  ansible.builtin.shell: >-
    pvesh get /nodes/{{ ansible_facts.hostname }}/lxc/{{ container_id }}/status/current
    --output-format json
  changed_when: false
  register: container_status_raw

- name: Remove container if managed by ansible
  ansible.builtin.shell: >-
    pvesh delete /nodes/{{ ansible_facts.hostname }}/lxc/{{ container_id }}
    --force 1
  vars:
    container_status: "{{ container_status_raw.stdout | from_json }}"
  when: managed_by_ansible_tag in container_status.tags | default('') | split(',')
  changed_when: true
